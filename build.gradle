apply plugin: 'java'
apply plugin: 'maven-publish'
apply plugin: 'maven'

/*
 * pipelite
 */

compileJava.options.encoding = 'UTF-8'

group = 'uk.ac.ebi'
ext.version_base = '2.4.1'
version = version_base
buildDir = 'target'


configurations.all {
    resolutionStrategy.cacheChangingModulesFor 0, 'seconds'

	if( !hasProperty( 'artifactoryUsername' ) )
		project.ext.properties.artifactoryUsername = ''
	else
		project.ext.properties.artifactoryUsername = artifactoryUsername;
		
	if( !hasProperty( 'artifactoryPassword' ) )
		project.ext.properties.artifactoryPassword = ''
	else
	 	project.ext.properties.artifactoryPassword = artifactoryPassword;
	 	
	if( !hasProperty( 'gitlab_private_token' ) )
		project.ext.properties.gitlab_private_token = ''
	else
		project.ext.properties.gitlab_private_token = gitlab_private_token;
	 
}




//ant.importBuild( 'build/beans-build.xml' ) { antTargetName -> 'ant' + antTargetName }

sourceSets {
	main {
		java {
			srcDir "src"
			srcDir "test"
		}

		resources {
		  srcDir 'resources'
    	}
	}
	
    test {
    	java {
			srcDir "src"
			srcDir "test"
    	}
	}
}


repositories {
    mavenLocal()
    maven { url "https://gitlab.ebi.ac.uk/api/v4/groups/enasequence/-/packages/maven" }
    maven { url "http://ena-dev:8081/artifactory/all" }
    mavenCentral()
    maven { url "http://maven.imagej.net/content/repositories/public/" } 
}


dependencies {
  compile(group: 'commons-dbutils', name: 'commons-dbutils', version: '1.3')
  compile(group: 'org.apache.commons', name: 'commons-exec', version: '1.3')
  compile(group: 'commons-io', name: 'commons-io', version: '1.3.2')
  compile(group: 'commons-lang', name: 'commons-lang', version: '2.4')
  compile(group: 'commons-net', name: 'commons-net', version: '2.0')
  compile(group: 'org.apache.commons', name: 'commons-compress', version: '1.10')
  compile(group: 'com.beust', name: 'jcommander', version: '1.71')
  
  compile(group: 'com.oracle', name: 'ojdbc8', version: '12.2.0.1.0')
  compile(group: 'com.oracle', name: 'xdb', version: '12.2.0.1.0')
  //compile(group: 'com.oracle', name: 'xmlparserv2', version: '12.2.0.1.0_PARSED_REMOVED_SERVICES' )

  compile 'org.apache.xmlbeans:xmlbeans:2.5.0'
  compile 'log4j:log4j:1.2.17'
  compile( group: 'javax.mail', name: 'mail', version: '1.4' )
  compile( group: 'org.mockito', name: 'mockito-all', version: '1.9.5' )
  compile( group: 'uk.ac.ebi', name: 'sra-base', version: '1.4.1' ) 
  compile "junit:junit:4.11"
  //TODO consider migration to ORM
  //compile( group: 'com.j256.ormlite', name: 'ormlite-jdbc', version: '5.0' )
}


sourceCompatibility = 1.8
targetCompatibility = 1.8

task sourceJar(type: Jar) { from sourceSets.main.allJava }


test {
	jvmArgs "-Dfile.encoding=UTF-8", "-Duser.timezone=GMT"
	maxHeapSize = '4G'

	outputs.upToDateWhen {false}
	testClassesDirs = sourceSets.main.output.classesDirs
	classpath       = sourceSets.main.runtimeClasspath;

  	// listen to events in the test execution lifecycle
  	beforeTest { descriptor ->
    	 logger.lifecycle("Running test: " + descriptor)
  	}

  	// listen to standard out and standard error of the test JVM(s)
/*	  onOutput { descriptor, event ->
    	 logger.lifecycle("Test: " + descriptor + " produced standard out/err: " + event.message )
  	}
*/  	
  	testLogging { //exceptionFormat "full"
  				  exceptionFormat "short"
  				  showStandardStreams true 
  				  showExceptions false
  	}
  	
}

//task wrapper(type: Wrapper) { gradleVersion = '1.12' }


install {
    repositories.mavenInstaller {
        pom.artifactId = 'pipelite'
    }
}

publishing {
    publications {
        mavenJava(MavenPublication) {
        	artifactId 'pipelite'
     		from components.java     	    	
	      	artifact sourceJar{ classifier "sources" }

	    pom {
    	    name = "Pipelite"
	        description = "Pipeline manager"
        	url = "https://github.com/enasequence/ena-pipelite"
        	licenses {
          		license {
            		name = "The Apache License, Version 2.0"
            		url = "http://www.apache.org/licenses/LICENSE-2.0.txt"
   		       	}
        	}
      	}
      }
    }

    repositories {
	    maven {
            // Project specific maven repository in Gitlab. 
            url "https://gitlab.ebi.ac.uk/api/v4/projects/883/packages/maven"
            // Developer token in Gitlab.
            credentials(HttpHeaderCredentials) {
                name = "Private-Token"
                value = project.ext.properties.gitlab_private_token
            }
            authentication {
                header( HttpHeaderAuthentication )
            }
	    }
    }
}


task writePom {
    doLast {
        pom {
            project {
                name = "Pipelite"
	        	description = "Pipeline manager"
        		url = "https://github.com/enasequence/ena-pipelite"
            
                licenses {
                    license {
                        name 'The Apache Software License, Version 2.0'
                        url 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                        distribution 'repo'
                    }
                }
            }
        }.writeTo( "pom.xml" )
    }
}   


compileJava.dependsOn( writePom )
