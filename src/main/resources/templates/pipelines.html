<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="fragments/header :: header"></div>
    <title>Pipelines</title>
    <script>

$(document).ready( function () {
    $('#pipelinesTable').DataTable({
        columns: [
            { data: "pipelineName" },
            { data: "maxRunningProcessCount" },
            { data: "runningProcessCount",
                render: function ( data, type, row, meta ) {
                    var url = "/pipelite/ui/processes?pipelineName=" + row.pipelineName;
                    return '<a href="' + url + '">' + row.runningProcessCount + '</a>';
                }
            }
        ],
        dom: 'tip',
        orderCellsTop: true,
        fixedHeader: true,
        responsive: true,
        language : {
           "zeroRecords": " "
        },
    });

    $('#statusTable').DataTable({
        columns: [
            { data: "pipelineName" },
            { data: "pendingCount" },
            { data: "activeCount" },
            { data: "completedCount" },
            { data: "failedCount" }
        ],
        dom: 'tip',
        orderCellsTop: true,
        fixedHeader: true,
        responsive: true,
        language : {
           "zeroRecords": " "
        },
    });


    // Show plot when tag is changed.
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        show();
    });

    show();
});

// Show the table and filter badges.
function show() {
    var pipelinesTable = $('#pipelinesTable').DataTable();
    var statusTable = $('#statusTable').DataTable();
    var since = $( "#since" ).val();
    var plotType = $( "#plotType" ).val();

    // Show the filter badges.
    var plotTypeBadgeText =$( "#plotType option:selected" ).text();
    $( "#plotTypeBadge" ).text(plotTypeBadgeText);

    var sinceBadgeText = "Last ";

    var minutes = since % 60;
    var hours = (since-minutes)/60 % 24;
    var days = (since-minutes-hours*60)/60/24;

    if (days == 1) {
        sinceBadgeText = sinceBadgeText + days + " day ";
    }
    if (days > 1) {
        sinceBadgeText = sinceBadgeText + days + " days ";
    }
    if (hours == 1) {
        sinceBadgeText = sinceBadgeText + hours + " hour ";
    }
    else if (hours > 1) {
        sinceBadgeText = sinceBadgeText + hours + " hours ";
    }
    if (minutes == 1) {
        sinceBadgeText = sinceBadgeText + minutes + " minute";
    }
    else if (minutes > 1) {
        sinceBadgeText = sinceBadgeText + minutes + " minutes";
    }
    $( "#sinceBadge" ).text(sinceBadgeText);

    // Show the tables.
    var pipelinesUrl = "/pipelite/pipeline/local";
    console.log(pipelinesUrl);
    $.get(pipelinesUrl, function(data, status) {
        pipelinesTable.clear().rows.add(data).draw();
    });
    var statusUrl = "/pipelite/pipeline/local/status";
    console.log(statusUrl);
    $.get(statusUrl, function(data, status) {
        statusTable.clear().rows.add(data).draw();
    });

    // Show the plot.
    plot();
}

// Show the plot.
function plot() {
    var since = $( "#since" ).val();
    var plotType = $( "#plotType" ).val();
     var url = "/pipelite/pipeline/local/plot/history?since=" + since + "&type=" + plotType + "&id=plot";
     console.log(url);
     $.getScript(url,
        function( data ) {
            // console.log( data );
        });
}































    </script>
</head>

<body>
<div th:replace="fragments/navigation :: navigation"></div>

<div class="mt-4 mb-4 ml-2 mr-2">
    <ul class="nav nav-tabs justify-content-center" role="tablist">
        <li class="nav-item" role="presentation"><a class="nav-link active" data-toggle="tab" role="tab"
                                                    href="#running">Local processes</a></li>
        <li class="nav-item" role="presentation"><a class="nav-link" data-toggle="tab" role="tab"
                                                    href="#history">Local history</a>
        <li class="nav-item" role="presentation"><a class="nav-link" data-toggle="tab" role="tab"
                                                    href="#status">All processes</a>
        </li>
    </ul>
</div>

<div class="tab-content">
    <div id="running" class="tab-pane fade show active" role="tabpanel">
        <div class="card m-2">
            <div class="card-body">
                <h5 class="card-title">Processes running in this server</h5>
                <table id="pipelinesTable" class="table table-striped table-hover" style="width:100%">
                    <!-- Header Table -->
                    <thead>
                    <tr>
                        <th>Pipeline</th>
                        <th>Maximum processes</th>
                        <th>Running processes</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <div id="history" class="tab-pane fade" role="tabpanel">
        <div class="card m-2">
            <div class="card-body">
                <h5 class="card-title">Select processes</h5>
                <div class="form-inline m-2">
                    <select class="custom-select m-2" id="plotType">
                        <option value="running">Running processes</option>
                        <option value="completed">Completed processes</option>
                        <option value="failed">Failed processes</option>
                        <option value="error">Internal errors</option>
                    </select>
                    <select class="custom-select m-2" id="since">
                        <!--
                        <option value="5" selected>Last 5 minutes</option>
                        <option value="15">Last 15 minutes</option>
                        -->
                        <option value="30">Last 30 minutes</option>
                        <option value="60">Last 1 hour</option>
                        <option value="120">Last 2 hours</option>
                        <option value="240">Last 4 hours</option>
                        <option value="480">Last 8 hours</option>
                        <option value="720">Last 12 hours</option>
                        <option value="1440">Last 1 day</option>
                        <option value="10080">Last 7 days</option>
                    </select>
                    <button type="submit" class="btn btn-primary m-2" onclick="show()">Show report</button>
                </div>
            </div>
        </div>
        <div class="card m-2">
            <div class="card-body">
                <h5 class="card-title">Processes running in this server</h5>
                <h5 class="mb-4">
                    <span class="badge badge-secondary" id="plotTypeBadge"></span>
                    <span class="badge badge-secondary" id="sinceBadge"></span>
                </h5>
                <div id="plot"></div>
            </div>
        </div>
    </div>
    <div id="status" class="tab-pane fade" role="tabpanel">
        <div class="card m-2">
            <div class="card-body">
                <h5 class="card-title">All processes</h5>
                <table id="statusTable" class="table table-striped table-hover" style="width:100%">
                    <!-- Header Table -->
                    <thead>
                    <tr>
                        <th>Pipeline</th>
                        <th>Pending processes</th>
                        <th>Active processes</th>
                        <th>Completed processes</th>
                        <th>Failed processes</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

</body>
</html>
