<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="fragments/header :: header"></div>
    <title>Process</title>
    <script th:inline="javascript">

$(document).ready(function() {
    $('#processTable').DataTable({
        columns: [
            // { data: "pipelineName" },
            // { data: "processId" },
            { data: "state" },
            { data: "startTime" },
            { data: "endTime" },
            { data: "executionCount" },
            { data: "priority" }
        ],
        dom: 't',
        responsive: true,
        language : {
           "zeroRecords": " "
        },
    });

    $('#stagesStatusTable').DataTable({
        columns: [
            { data: "pipelineName", visible: false, searchable: false },
            { data: "processId", visible: false, searchable: false },
            { data: "stageName" },
            { data: "resultType" },
            { data: "startTime" },
            { data: "endTime" },
            { data: "executionTime" },
            { data: "executionCount" },
            {
                "data": null,
                "defaultContent": "<button class=\"btn btn-outline-secondary mr-2\">Logs</button>"
            }
        ],
        dom: 'tBip',
        buttons: {
            buttons: [
                { extend: 'copy', className: 'btn btn-outline-secondary' },
                { extend: 'csv', className: 'btn btn-outline-secondary' },
                { extend: 'excel', className: 'btn btn-outline-secondary' }
            ],
            dom: {
    		  button: {
	    	    className: 'btn'
	          }
            }
        },
        orderCellsTop: true,
        fixedHeader: true,
        responsive: true,
        language : {
           "zeroRecords": " "
        },
    });

    $('#stagesDataTable').DataTable({
        columns: [
            { data: "pipelineName", visible: false, searchable: false },
            { data: "processId", visible: false, searchable: false },
            { data: "stageName" },
            { data: "executorName" },
            { data: "executorData" },
            { data: "executorParams" },
            { data: "resultParams" },
        ],
        dom: 'tBip',
        buttons: {
            buttons: [
                { extend: 'copy', className: 'btn btn-outline-secondary' },
                { extend: 'csv', className: 'btn btn-outline-secondary' },
                { extend: 'excel', className: 'btn btn-outline-secondary' }
            ],
            dom: {
    		  button: {
	    	    className: 'btn'
	          }
            }
        },
        orderCellsTop: true,
        fixedHeader: true,
        responsive: true,
        language : {
           "zeroRecords": " "
        },
    });

    // Logs button is pressed.
    $('#stagesStatusTable tbody').on( 'click', 'button', function () {
        var table = $('#stagesStatusTable').DataTable();
        var data = table.row( $(this).parents('tr') ).data();
        var url =  "/pipelite/log/" + window.pipelineName + "/" + window.processId + "/" + data.stageName + "/";
        console.log(url);
        $.get(url, function(data, status) {
                $( "#logsText" ).text( data.log );
                $('#logsModal').modal('show');
         });
    } );

    // Set up autocomplete for pipeline name.
    var url = "/pipelite/process/local";
    $.get(url, function(data, status) {

        var pipelineNames = data.map(function (obj) {
            return obj.pipelineName;
        });
        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }
        pipelineNames = pipelineNames.filter(onlyUnique);

        $( "#pipelineName" ).autocomplete({
          source: pipelineNames,
          minLength: 0,
          open: function() {
            $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
          },
          close: function() {
            $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
          }
        });
    });

    // Show tables and graph.
    var urlParams = new URLSearchParams(window.location.search);
    var pipelineName = urlParams.get("pipelineName");
    var processId = urlParams.get("processId");
    // console.log("url parameter pipelineName:" + pipelineName);
    // console.log("url parameter processId:" + processId);
    if (pipelineName && processId) {
       $( "#pipelineName" ).val(pipelineName);
       $( "#processId" ).val(processId);
        show();
    }

    // Show graph when tag is changed.
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        $('svg').remove();
        plot();
 });
});

// Show the filter badges, tables and graph.
function show() {
    var pipelineName = $( "#pipelineName" ).val();
    var processId = $( "#processId" ).val();

    if (pipelineName && processId) {
        console.log("show");

        $( "#alert" ).hide();

        // Save pipeline name and processId.
        window.pipelineName = pipelineName;
        window.processId = processId;

        // Show the filter badges.
        var pipelineNameBadgeText;
        var processIdBadgeText;
        if (pipelineName) {
            pipelineNameBadgeText = "Pipeline:" + pipelineName;
        }
        else {
            pipelineNameBadgeText = "";
        }
        if (processId) {
            processIdBadgeText = "Process:" + processId;
        }
        else {
            processIdBadgeText = "";
        }
        $( "#pipelineNameBadge" ).text(pipelineNameBadgeText);
        $( "#processIdBadge" ).text(processIdBadgeText);

        // Show the tables.
        var processTable = $('#processTable').DataTable();
        var stagesStatusTable = $('#stagesStatusTable').DataTable();
        var stagesDataTable = $('#stagesDataTable').DataTable();

        var processUrl =  "/pipelite/process/" + window.pipelineName + "/" + processId + "/";
        console.log(processUrl);
        $.get(processUrl, function(data, status) {
            processTable.clear().rows.add(data).draw();
         });

        var stagesUrl =  "/pipelite/stage/" + window.pipelineName + "/" + processId + "/";
        console.log(stagesUrl);
        $.get(stagesUrl, function(data, status) {
            stagesStatusTable.clear().rows.add(data).draw();
            stagesDataTable.clear().rows.add(data).draw();
         });

        // Show the graph.
        plot();
    }
    else {
        $( "#alert" ).text("Please provide pipeline name and process id");
        $( "#alert" ).show();
    }
};

// Show graph.
function plot() {

    var minWidth = 100;
    var fullWidth = $("#stagesGraph").width();
    if (fullWidth < minWidth) {
       return;
    }
    var fullHeight = 500;
    $("#stagesGraph").height(fullHeight);

    var url =  "/pipelite/stage/" + window.pipelineName + "/" + window.processId + "/";
    console.log(url);
    $.get(url, function(data, status) {
        var g = new dagreD3.graphlib.Graph()
          .setGraph({
              ranksep: 20,
              nodesep: 20,
              rankdir: "LR"
          })
          .setDefaultEdgeLabel(function() { return {}; });

        // Set nodes
        data.forEach(function(stage) {
            if (stage.resultType == "SUCCESS") {
               g.setNode(stage.stageName, { label: stage.stageName, class: "stageSuccess" });
            }
            else if (stage.resultType == "ERROR") {
               g.setNode(stage.stageName, { label: stage.stageName, class: "stageError" });
            }
            else if (stage.resultType == "ACTIVE") {
               g.setNode(stage.stageName, { label: stage.stageName, class: "stageActive" });
            }
            else {
               g.setNode(stage.stageName, { label: stage.stageName });
            }
        });

        // Set edges
        data.forEach(function(stage) {
            stage.dependsOnStage.forEach(function(dependsOnStage) {
                g.setEdge(dependsOnStage, stage.stageName, {
                // label: "depends on"
                });
            });
        });

        // Set some general styles
        g.nodes().forEach(function(v) {
          var node = g.node(v);
          node.rx = node.ry = 5;
        });

        // Add some custom colors based on state
        // g.node('CLOSED').style = "fill: #f77";
        // g.node('ESTAB').style = "fill: #7f7";

        var svg = d3.select("#stagesGraph").append("svg")
           .attr("width", fullWidth)
           .attr("height", fullHeight);
        var svgGroup = svg.append("g");

        var render = new dagreD3.render();
        render(d3.select("svg g"), g);

        var paddingPercent = 0.95;
        var svgGroupBounds = svgGroup.node().getBBox();
        var width = svgGroupBounds.width,
            height = svgGroupBounds.height;

        var midX = svgGroupBounds.x + width / 2,
            midY = svgGroupBounds.y + height / 2;
        var maxScale = 1;
        var minScale = 0.75;
        var scale = (paddingPercent || 0.75) / Math.max(width / fullWidth, height / fullHeight);
        if(scale > maxScale) {
           scale = maxScale;
        }
        if(scale < minScale) {
           scale = minScale;
        }
        var leftMargin = 10;
        var translate = [leftMargin /*fullWidth / 2 - scale * midX*/, fullHeight / 2 - scale * midY];
        // console.log("scale: " + scale);
        // console.log("translate: " + translate);
        svgGroup.attr('transform',
            'translate(' + translate + ')' +
            'scale(' + scale + ')');
     });
};


// Copy logs.
function copy() {
    var range = document.createRange();

    range.selectNode(document.getElementById("logsText"));
    window.getSelection().removeAllRanges(); // clear current selection
    window.getSelection().addRange(range); // to select text
    document.execCommand("copy");
    window.getSelection().removeAllRanges();// to deselect
};












    </script>
</head>

<body>
<div th:replace="fragments/navigation :: navigation"></div>

<!-- The Modal -->
<div class="modal fade" id="logsModal">
    <div class="modal-dialog modal-dialog-scrollable" style="width:95%;max-width:1250px">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Logs</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="logsText">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="copy()">Copy</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="card m-2">
    <div class="card-body">
        <h5 class="card-title">Select process</h5>
        <div class="form-inline m-2">
            <label class="mr-2" for="pipelineName">Pipeline</label>
            <input type="text" class="form-control m-2" id="pipelineName">
            <label class="mr-2" for="processId">Process</label>
            <input type="text" class="form-control m-2" id="processId">
            <button type="submit" class="btn btn-primary m-2" onclick="show()">Show process</button>
        </div>
        <div class="alert alert-warning" style="display: none;" role="alert" id="alert">
        </div>
    </div>
</div>

<div class="card m-2">
    <div class="card-body">

        <h5 class="card-title">Process</h5>

        <h5 class="mb-4">
            <span class="badge badge-secondary" id="pipelineNameBadge"></span>
            <span class="badge badge-secondary" id="processIdBadge"></span>
        </h5>

        <table id="processTable" class="table table-striped table-hover" style="width:100%">
            <thead>
            <tr>
                <th>Status</th>
                <th>Start time</th>
                <th>End time</th>
                <th>Execution count</th>
                <th>Priority</th>
            </tr>
            </thead>
        </table>
    </div>
</div>

<div class="card m-2">
    <div class="card-body">

        <h5 class="card-title">Stages</h5>
        <ul class="nav nav-tabs justify-content-center" role="tablist">
            <li class="nav-item" role="presentation"><a class="nav-link active" data-toggle="tab" role="tab"
                                                        href="#status">Status</a></li>
            <li class="nav-item" role="presentation"><a class="nav-link" data-toggle="tab" role="tab"
                                                        href="#data">Data</a>
            </li>
            <li class="nav-item" role="presentation"><a class="nav-link" data-toggle="tab" role="tab"
                                                        href="#graph">Graph</a>
            </li>
        </ul>

        <div class="tab-content">
            <div id="status" class="tab-pane fade show active" role="tabpanel">
                <table id="stagesStatusTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                    <tr>
                        <th>Pipeline</th>
                        <th>Process</th>
                        <th>Stage</th>
                        <th>Status</th>
                        <th>Start time</th>
                        <th>End time</th>
                        <th>Execution time</th>
                        <th>Execution count</th>
                        <th>Logs</th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div id="data" class="tab-pane fade" role="tabpanel">
                <table id="stagesDataTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                    <tr>
                        <th>Pipeline</th>
                        <th>Process</th>
                        <th>Stage</th>
                        <th>Executor name</th>
                        <th>Executor data</th>
                        <th>Executor params</th>
                        <th>Result params</th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div id="graph" class="tab-pane fade" role="tabpanel">
                <div id="stagesGraph" class="border rounded" style="width:100%;overflow:scroll;">
                    <!--   <svg width="960" height="960" style="background:yellow"></svg> -->
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>



