<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="fragments/header :: header"></div>
    <title>Processes</title>
    <script th:inline="javascript">
        $(document).ready(function () {
            $('#runningTable').DataTable({
                columns: [
                    {data: "pipelineName"},
                    {
                        data: "processId",
                        render: function (data, type, row, meta) {
                            var url = "/pipelite/ui/process?pipelineName=" + row.pipelineName + "&processId=" + row.processId;
                            return '<a href="' + url + '">' + row.processId + '</a>';
                        }
                    },
                    {data: "state"},
                    {
                        data: "startTime",
                        render: function (data) {
                            return moment(data).format('YYYY/MM/DD hh:mm:ss');
                        }
                    },
                    {
                        data: "endTime",
                        render: function (data) {
                            return moment(data).format('YYYY/MM/DD hh:mm:ss');
                        }
                    },
                    {data: "executionCount"},
                    {data: "priority"}
                ],
                dom: 'frtBip',
                buttons: {
                    buttons: [
                        {extend: 'copy', className: 'btn btn-outline-secondary'},
                        {extend: 'csv', className: 'btn btn-outline-secondary'},
                        {extend: 'excel', className: 'btn btn-outline-secondary'}
                    ],
                    dom: {
                        button: {
                            className: 'btn'
                        }
                    }
                },
                orderCellsTop: true,
                fixedHeader: true,
                responsive: true,
                language: {
                    "zeroRecords": " "
                },
            });

            // Set up autocomplete for pipeline name.
            var url = "/pipelite/process/";
            $.get(url, function (data, status) {

                var pipelineNames = data.map(function (obj) {
                    return obj.pipelineName;
                });

                function onlyUnique(value, index, self) {
                    return self.indexOf(value) === index;
                }

                pipelineNames = pipelineNames.filter(onlyUnique);

                $("#pipelineName").autocomplete({
                    source: pipelineNames,
                    minLength: 0,
                    open: function () {
                        $(this).removeClass("ui-corner-all").addClass("ui-corner-top");
                    },
                    close: function () {
                        $(this).removeClass("ui-corner-top").addClass("ui-corner-all");
                    }
                });
            });

            var urlParams = new URLSearchParams(window.location.search);
            var pipelineName = urlParams.get("pipelineName");
            // console.log("url parameter pipelineName:" + pipelineName);
            if (pipelineName) {
                $("#pipelineName").val(pipelineName);
            }

            show();
        });

        // Show the filter badge and table.
        function show() {
            var runningTable = $('#runningTable').DataTable();
            var pipelineName = $("#pipelineName").val();

            // Save pipeline name.
            // window.pipelineName = pipelineName;

            // Show the filter badge.
            var pipelineNameBadgeText;
            if (pipelineName) {
                pipelineNameBadgeText = "Pipeline:" + pipelineName;
            } else {
                pipelineNameBadgeText = "";
            }
            $("#pipelineNameBadge").text(pipelineNameBadgeText);

            // Show the table.
            var url = "/pipelite/process/";
            if (pipelineName) {
                url = url + "?pipelineName=" + pipelineName + "&";
            }
            console.log(url);
            $.get(url, function (data, status) {
                runningTable.clear().rows.add(data).draw();
            });
        };


    </script>
</head>

<body>
<div th:replace="fragments/navigation :: navigation"></div>

<div class="card m-2">
    <div class="card-body">
        <h5 class="card-title">Select processes</h5>

        <div class="form-inline m-2">

            <label class="mr-2" for="pipelineName">Pipeline</label>
            <input type="text" class="form-control m-2" id="pipelineName">

            <button type="submit" class="btn btn-primary m-2" onclick="show()">Show processes</button>
        </div>
        <h5 class="mb-4">
            <span class="badge badge-secondary" id="pipelineNameBadge"></span>
        </h5>
    </div>
</div>

<div class="card m-2">
    <div class="card-body">
        <h5 class="card-title">Processes running in this server</h5>

        <table id="runningTable" class="table table-striped table-hover" style="width:100%">
            <thead>
            <tr>
                <th>Pipeline</th>
                <th>Process</th>
                <th>Status</th>
                <th>Start time</th>
                <th>End time</th>
                <th>Execution count</th>
                <th>Priority</th>
            </tr>
            </thead>
        </table>
    </div>
</div>
</body>
</html>
